<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Parking Plate Checker</title>
</head>
<body>
    <h1>Number Plate Checker</h1>
    <input type="text" id="plateInput" placeholder="Enter Plate Number" />
    <button onclick="checkPlate()">Check Plate</button>
    <p id="result"></p>

    <h2>Available Parking Spaces: <span id="parkingSpaces">Loading...</span></h2>

    <hr>
    <h1>Traffic Congestion Reporter</h1>
    <p>Send a few location + congestion levels and see what the server thinks</p>
    <input type="text" id="locationInput" placeholder="Enter Location" />
    <select id="congestionLevel">
        <option value="1">1 - Heavy</option>
        <option value="2">2</option>
        <option value="3">3 - Medium</option>
        <option value="4">4</option>
        <option value="5">5 - Very Light</option>
    </select>
    <button onclick="addTraffic()">Add Report</button>
    <button onclick="submitTraffic()">Submit All</button>

    <ul id="trafficList"></ul>
    <p id="trafficSummary"></p>
    
    <hr>
    <h2>Registered Services</h2>
    <ul id="discoveryList"></ul>
    

    <script>
        const trafficReports = [];

        function checkPlate() {
            const plateNumber = document.getElementById('plateInput').value;

            fetch('/checkPlate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': 'daveDistSys2025'//api.key, not the securest way of sending!!
                },
                body: JSON.stringify({ registrationPlate: plateNumber }) // now camelCase
            })
            .then(response => response.json())
            .then(data => {
                const statusText = data.approved ? "Allowed" : "Denied";
                document.getElementById('result').innerText = `Plate status: ${statusText} (${data.message})`;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerText = 'Error checking plate';
            });
        }

        const eventSource = new EventSource('/parkingSpaces');
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            document.getElementById("parkingSpaces").textContent = data.availableSpaces; // now camelCase
        };

        // Add a traffic report to memory
        function addTraffic() {
            const location = document.getElementById('locationInput').value;
            const congestion = parseInt(document.getElementById('congestionLevel').value);

            if (!location) {
                alert("Enter a location first silly!.");
                return;
            }

            trafficReports.push({ location, congestionLevel: congestion });

            const list = document.getElementById('trafficList');
            const item = document.createElement('li');
            item.textContent = `${location} - Level ${congestion}`;
            list.appendChild(item);

            document.getElementById('locationInput').value = '';
        }

        // Send all reports to backend for gRPC streaming
        function submitTraffic() {
            if (trafficReports.length === 0) {
                alert("Add at least one traffic report first!");
                return;
            }

            fetch('/reportTraffic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': 'daveDistSys2025'//api.key, not the securest way of sending!!
                },
                body: JSON.stringify(trafficReports)
            })
            .then(response => response.json())
            .then(summary => {
                document.getElementById('trafficSummary').innerText = `Average Congestion: ${summary.averageCongestion.toFixed(1)} | Reports: ${summary.totalReports} | Most Reported Location: ${summary.mostReportedLocation}`;
                trafficReports.length = 0; // reset
                document.getElementById('trafficList').innerHTML = '';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('trafficSummary').innerText = 'Error getting summary';
            });
        }

        function loadDiscoveredServices() {
            fetch('/discoveredServices',{
                headers: {
        'x-api-key': 'daveDistSys2025' // again not secure
            }})
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('discoveryList');
                list.innerHTML = ''; // clear previous

                data.forEach(service => {
                    const item = document.createElement('li');
                    item.textContent = `${service.serviceName} (${service.serviceType}) @ ${service.address} â€“ ${service.status}`;
                    list.appendChild(item);
            });
            })
            .catch(err => {
                console.error('Failed to load discovered services:', err);
        });
}
        // Call it once on page load
        loadDiscoveredServices();

        // Optional: refresh every 10 seconds
        setInterval(loadDiscoveredServices, 10000);


    </script>
</body>
</html>
